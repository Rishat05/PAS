import{n as m,s as r}from"./index.0a3858b9.js";var p=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"camera-comp"},[s("video",{directives:[{name:"show",rawName:"v-show",value:!t.photo,expression:"!photo"}],ref:"video",staticClass:"video",class:t.facingMode==="user"?"front":""}),s("div",{directives:[{name:"show",rawName:"v-show",value:t.isShowCanvas,expression:"isShowCanvas"}],staticClass:"canvas"},[s("canvas",{ref:"canva"})]),t.photo?s("div",{attrs:{id:"image_text"}},[t.photo?s("img",{staticClass:"cap-photo",attrs:{src:t.photo,alt:"photo",id:"img_prev"}}):t._e(),t._l(t.$store.state.customer.ocrResponseElements,function(a,i){return s("div",{directives:[{name:"show",rawName:"v-show",value:t.photo&&t.$store.state.customer.ocrResponseElements.length>0,expression:"photo && $store.state.customer.ocrResponseElements.length > 0"}],key:i,class:a.selected?"colored-shed bounding-box":"gray-shed bounding-box",style:{top:a.y1+"px",left:a.x1+"px",width:a.x2-a.x1+"px",height:a.y2-a.y1+"px"},on:{click:function(n){return t.getSelectedElement(a)}}})})],2):t._e(),s("b-loading",{attrs:{"is-full-page":t.isFullPage,"can-cancel":!1},model:{value:t.isLoading,callback:function(a){t.isLoading=a},expression:"isLoading"}})],1)},v=[];const f={components:{},data(){return{isShowCanvas:!1,photo:null,image:null,mediaStream:null,videoDevices:[],facingMode:"environment",counter:0,switchingCamera:!1,canva:null,selectedTexts:[],isFullPage:!0,isLoading:!1,reducedSize:0,start:0,end:0}},mounted(){this.openCamera()},beforeDestroy(){this.closeCamera()},methods:{async openCamera(){const t=await navigator.mediaDevices.enumerateDevices();this.videoDevices=t.filter(e=>e.kind==="videoinput"),await this.StartRecording("environment")},async StartRecording(t){this.facingMode=t;let e=this.$refs.video;return e.setAttribute("autoplay",""),e.setAttribute("muted",""),e.setAttribute("playsinline",""),this.mediaStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:t,width:500,height:500},audio:!1}),e.srcObject=this.mediaStream,await e.play()},ReTakePhoto(){this.photo=null,this.openCamera()},async TakePhoto(){let t=this.$refs.video;this.canva=this.$refs.canva;let e=t.videoWidth,s=t.videoHeight;this.canva.width=e,this.canva.height=s;let a=this.canva.getContext("2d");this.facingMode==="user"&&a.scale(-1,1),a.drawImage(t,0,0,e,s),a.save(),this.photo=this.canva.toDataURL("image/jpeg"),this.closeCamera(),this.start=new Date().getTime(),this.Send()},closeCamera(){const e=this.$refs.video.srcObject;if(e){const s=e.getTracks();s[0].stop(),s.forEach(a=>a.stop())}},async Send(){this.isLoading=!0;let t=new FormData;t.append("awsInstance","t2 samll"),t.append("image",this.photo),await this.$store.dispatch("customer/getOCRDataBySchedule",t).then(e=>{if(e.status_code===200&&e.data.status===0){let s={id:e.data.id};this.getOCRResult(s)}}).catch(e=>{this.isLoading=!1,r(e.response.data.error+"! "+e.response.data.message,"is-danger")})},getOCRResult(t){this.$store.dispatch("customer/getOCRResult",t).then(e=>{if(e.data.status!==1){let s=this;setTimeout(()=>{s.getOCRResult(t)},100)}else{this.isLoading=!1,e.data.ocr_data!==null||(this.ReTakePhoto(),r("\u8A8D\u8B58\u6587\u5B57\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093\u3067\u3057\u305F\u3002\u518D\u5EA6\u8A66\u3059\u304B\u691C\u7D22\u6587\u5B57\u3092\u5165\u529B\u304F\u3060\u3055\u3044\u3002","is-danger"));let s={id:0,type:"ocr",photo:this.photo,ocrData:e.data.ocr_data,image:this.canva.toDataURL("image/jpeg")};this.$store.dispatch("global/setCapturedImages",s);let a=e.data.ocr_data;a.length>0?(this.$store.dispatch("customer/setOCROriginalResponse",a),this.makeBoundingBox(a)):r("\u8A8D\u8B58\u6587\u5B57\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093\u3067\u3057\u305F\u3002\u518D\u5EA6\u8A66\u3059\u304B\u691C\u7D22\u6587\u5B57\u3092\u5165\u529B\u304F\u3060\u3055\u3044\u3002","is-danger")}}).catch(e=>{this.isLoading=!1,r(e.response.data.error+"! "+e.response.data.message,"is-danger")})},makeBoundingBox(t){let e=[];t.forEach((s,a)=>{let i=[s.bounding_box.x1,s.bounding_box.x2,s.bounding_box.x3,s.bounding_box.x4],n=[s.bounding_box.y1,s.bounding_box.y2,s.bounding_box.y3,s.bounding_box.y4],c=i[0],d=i[0],l=n[0],h=n[0];for(let o=1;o<i.length;o++)i[o]>d?d=i[o]:i[o]<c&&(c=i[o]);for(let o=1;o<n.length;o++)n[o]>h?h=n[o]:n[o]<l&&(l=n[o]);let u={id:a,text:s.text,x1:c*.828,x2:d*.828,y1:l*.828,y2:h*.828,selected:!1};e.push(u)}),this.$store.dispatch("customer/setOCRResponseElements",e)},generateImage(){let t=document.getElementById("img_prev");var e=document.createElement("canvas"),s=e.getContext("2d");e.setAttribute("width",500),e.setAttribute("height",500),s.drawImage(t,0,0,500,500),this.$store.state.customer.ocrResponseElements.forEach((i,n)=>{s.beginPath(),s.rect(i.x1/.828,i.y1/.828,i.x2/.828-i.x1/.828,i.y2/.828-i.y1/.828),i.selected?(s.fillStyle="rgba(14, 177, 232, 0.4)",s.fill(),s.strokeStyle="#0EB1E8",s.stroke()):(s.fillStyle="rgba(255, 255, 255, 0.2)",s.fill(),s.strokeStyle="#fff",s.stroke())});let a=e.toDataURL("image/jpeg");this.$store.dispatch("customer/setBoundingBoxImage",a)},getSelectedElement(t){let e=this.$store.state.customer.ocrResponseSelectedElements.find(s=>s.id===t.id);e?(e.selected=!1,this.$store.state.customer.ocrResponseSelectedElements.splice(this.$store.state.customer.ocrResponseSelectedElements.indexOf(e),1)):(t.selected=!0,this.$store.dispatch("customer/setOCRResponseSelectedElements",t)),this.$emit("getText",this.$store.state.customer.ocrResponseSelectedElements)}}},g={};var x=m(f,p,v,!1,_,"0a224a01",null,null);function _(t){for(let e in g)this[e]=g[e]}var b=function(){return x.exports}();export{b as c};
